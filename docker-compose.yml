version: "3.8"
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-analytics}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-analytics}
      POSTGRES_DB: ${POSTGRES_DB:-analytics}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "6379:6379"

  ingestion:
    build:
      context: ./ingestion-service
      dockerfile: DockerFile
    env_file:
      - .env
    environment:
      - PORT=${INGESTION_PORT:-3000}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_STREAM_NAME=${REDIS_STREAM_NAME:-events-stream}
    depends_on:
      - redis
    ports:
      - "${INGESTION_PORT:-3000}:${INGESTION_PORT:-3000}"

  processor:
    build:
      context: ./processor-service
      dockerfile: DockerFile
    env_file:
      - .env
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_STREAM_NAME=${REDIS_STREAM_NAME:-events-stream}
      - REDIS_CONSUMER_GROUP=${REDIS_CONSUMER_GROUP:-events-group}
      - REDIS_CONSUMER_NAME=${PROCESSOR_CONSUMER_NAME:-worker-1}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-analytics}:${POSTGRES_PASSWORD:-analytics}@postgres:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-analytics}
    depends_on:
      - redis
      - postgres
    restart: on-failure

  reporting:
    build:
      context: ./reporting-service
      dockerfile: DockerFile
    env_file:
      - .env
    environment:
      - PORT=${REPORTING_PORT:-3001}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-analytics}:${POSTGRES_PASSWORD:-analytics}@postgres:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-analytics}
    depends_on:
      - postgres
    ports:
      - "${REPORTING_PORT:-3001}:${REPORTING_PORT:-3001}"

volumes:
  pgdata:
